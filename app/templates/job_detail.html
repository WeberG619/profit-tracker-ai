{% extends "base.html" %}

{% block title %}Job #{{ job.job_number }} - Receipt Processor{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{{ url_for('analytics_dashboard') }}" class="text-blue-600 hover:text-blue-800 mb-2 inline-block">
            <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
        </a>
        <div class="flex justify-between items-start">
            <div>
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Job #{{ job.job_number }}</h2>
                <p class="text-lg text-gray-600">{{ job.customer_name }}</p>
            </div>
            <div class="space-x-2">
                <a href="{{ url_for('export_job_pdf', job_id=job.id) }}" 
                   class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-file-pdf mr-2"></i>Export PDF
                </a>
                <a href="{{ url_for('upload_page') }}?job={{ job.job_number }}" 
                   class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Add Receipt
                </a>
            </div>
        </div>
    </div>
    
    <!-- Profit Overview Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Quote Card -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <p class="text-gray-500 text-sm font-medium">Original Quote</p>
            <p class="text-2xl font-bold text-gray-800 mt-1">${{ "%.2f"|format(job.quoted_price or 0) }}</p>
        </div>
        
        <!-- Current Costs Card -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <p class="text-gray-500 text-sm font-medium">Current Costs</p>
            <p class="text-2xl font-bold text-gray-800 mt-1">${{ "%.2f"|format(job.current_costs) }}</p>
            <p class="text-sm text-gray-500 mt-1">{{ job.receipts|length }} receipts</p>
        </div>
        
        <!-- Profit Margin Card -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <p class="text-gray-500 text-sm font-medium">Profit Margin</p>
            <div class="mt-2">
                <!-- Profit Gauge -->
                <div class="relative pt-1">
                    <div class="overflow-hidden h-8 text-xs flex rounded bg-gray-200">
                        <div style="width:{{ [job.profit_margin, 0]|max }}%" 
                             class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center
                                {% if job.status_color == 'green' %}bg-green-500
                                {% elif job.status_color == 'yellow' %}bg-yellow-500
                                {% else %}bg-red-500{% endif %}">
                            <span class="font-bold">{{ "%.1f"|format(job.profit_margin) }}%</span>
                        </div>
                    </div>
                </div>
                <p class="text-lg font-semibold mt-2 {% if job.profit_amount < 0 %}text-red-600{% else %}text-green-600{% endif %}">
                    ${{ "%.2f"|format(job.profit_amount) }} profit
                </p>
            </div>
        </div>
    </div>
    
    <!-- Cost Timeline -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Cost Timeline</h3>
        <div class="overflow-x-auto">
            <canvas id="costChart" class="w-full" style="height: 300px;"></canvas>
        </div>
    </div>
    
    <!-- Receipts List -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800">All Receipts</h3>
        </div>
        
        {% if job.receipts %}
        <div class="divide-y divide-gray-200">
            {% for receipt in job.receipts|sort(attribute='created_at', reverse=True) %}
            <div class="p-4 hover:bg-gray-50 transition-colors">
                <div class="flex items-start space-x-4">
                    <!-- Thumbnail -->
                    <img src="{{ url_for('uploaded_file', filename=receipt.image_path) }}" 
                         alt="Receipt"
                         class="w-20 h-20 object-cover rounded cursor-pointer"
                         onclick="viewImage('{{ url_for('uploaded_file', filename=receipt.image_path) }}')">
                    
                    <!-- Receipt Info -->
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-gray-800">{{ receipt.vendor_name or 'Unknown Vendor' }}</h4>
                                <p class="text-sm text-gray-600">
                                    {{ receipt.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                    {% if receipt.upload_method == 'sms' %}
                                    <span class="ml-2 text-purple-600">
                                        <i class="fas fa-sms"></i> SMS
                                    </span>
                                    {% endif %}
                                </p>
                                {% if receipt.receipt_number %}
                                <p class="text-sm text-gray-500">Receipt #{{ receipt.receipt_number }}</p>
                                {% endif %}
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-semibold text-gray-800">${{ "%.2f"|format(receipt.total_amount or 0) }}</p>
                                <a href="{{ url_for('review_receipt', receipt_id=receipt.id) }}" 
                                   class="text-sm text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                            </div>
                        </div>
                        
                        <!-- Line Items Preview -->
                        {% if receipt.line_items %}
                        <div class="mt-2 text-sm text-gray-600">
                            {% for item in receipt.line_items[:3] %}
                            <div class="flex justify-between">
                                <span>{{ item.description }}</span>
                                <span>${{ "%.2f"|format(item.amount) }}</span>
                            </div>
                            {% endfor %}
                            {% if receipt.line_items|length > 3 %}
                            <p class="text-gray-400 italic">... and {{ receipt.line_items|length - 3 }} more items</p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-receipt text-6xl text-gray-300 mb-4"></i>
            <p class="text-xl text-gray-500">No receipts uploaded yet</p>
            <a href="{{ url_for('upload_page') }}?job={{ job.job_number }}" 
               class="mt-4 inline-block bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">
                Upload First Receipt
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
    <div class="relative max-w-4xl max-h-[90vh] p-4">
        <button onclick="closeModal()" 
                class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center hover:bg-opacity-75">
            <i class="fas fa-times"></i>
        </button>
        <img id="modalImage" src="" alt="Receipt" class="max-w-full max-h-full rounded-lg">
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Timeline data
    const timelineData = {{ timeline|tojson }};
    
    // Create cost timeline chart
    const ctx = document.getElementById('costChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: timelineData.map(item => item.date),
            datasets: [{
                label: 'Running Total',
                data: timelineData.map(item => item.running_total),
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.1
            }, {
                label: 'Quote',
                data: Array(timelineData.length).fill({{ job.quoted_price or 0 }}),
                borderColor: 'rgb(34, 197, 94)',
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': $';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toFixed(2);
                            }
                            
                            // Add vendor info for running total
                            if (context.datasetIndex === 0 && timelineData[context.dataIndex]) {
                                label += ' (' + timelineData[context.dataIndex].vendor + ')';
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(0);
                        }
                    }
                }
            }
        }
    });
    
    function viewImage(url) {
        document.getElementById('modalImage').src = url;
        document.getElementById('imageModal').classList.remove('hidden');
        document.getElementById('imageModal').classList.add('flex');
    }
    
    function closeModal() {
        document.getElementById('imageModal').classList.add('hidden');
        document.getElementById('imageModal').classList.remove('flex');
    }
    
    // Close modal on background click
    document.getElementById('imageModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
</script>
{% endblock %}